name: Stock V2 Analysis After Crawl

on:
  workflow_run:
    workflows:
      - RSS Crawler
    types:
      - completed
  workflow_dispatch:
    inputs:
      legacy_fallback:
        description: "Run legacy enhanced analyzer pipeline"
        required: false
        default: false
        type: boolean
      enable_llm:
        description: "Enable LLM correction in Stock V2 pipeline"
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch || github.ref_name }}
  cancel-in-progress: false

jobs:
  stock-v2-analysis:
    if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || (github.event_name == 'workflow_dispatch' && inputs.legacy_fallback != true) }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      LLM_VERBOSE_LOGS: ${{ vars.LLM_VERBOSE_LOGS || 'false' }}
      ENABLE_STOCK_V3_RUN_LOG: ${{ vars.ENABLE_STOCK_V3_RUN_LOG || 'false' }}
      ENABLE_STOCK_V3_EVAL: ${{ vars.ENABLE_STOCK_V3_EVAL || 'false' }}
      ENABLE_STOCK_V3_PAPER: ${{ vars.ENABLE_STOCK_V3_PAPER || 'false' }}
      ENABLE_STOCK_V3_CHALLENGER: ${{ vars.ENABLE_STOCK_V3_CHALLENGER || 'false' }}
      ENABLE_STOCK_V3_DRIFT: ${{ vars.ENABLE_STOCK_V3_DRIFT || 'false' }}
      ENABLE_STOCK_V3_LIFECYCLE: ${{ vars.ENABLE_STOCK_V3_LIFECYCLE || 'false' }}
      ENABLE_STOCK_V3_SUBSCRIPTION_ALERT: ${{ vars.ENABLE_STOCK_V3_SUBSCRIPTION_ALERT || 'false' }}
      ENABLE_STOCK_V3_CONSTRAINTS: ${{ vars.ENABLE_STOCK_V3_CONSTRAINTS || 'false' }}
      ENABLE_STOCK_V3_SCORECARD: ${{ vars.ENABLE_STOCK_V3_SCORECARD || 'false' }}
      ENABLE_STOCK_V3_SHADOW_REPORT: ${{ vars.ENABLE_STOCK_V3_SHADOW_REPORT || 'false' }}
      ENABLE_STOCK_V3_VALIDATION: ${{ vars.ENABLE_STOCK_V3_VALIDATION || 'false' }}
      ENABLE_STOCK_X_SOURCE: ${{ vars.ENABLE_STOCK_X_SOURCE || 'true' }}
      ENABLE_STOCK_EVIDENCE_LAYER: ${{ vars.ENABLE_STOCK_EVIDENCE_LAYER || 'false' }}
      ENABLE_STOCK_TRANSMISSION_LAYER: ${{ vars.ENABLE_STOCK_TRANSMISSION_LAYER || 'false' }}
      ENABLE_STOCK_AI_DEBATE_VIEW: ${{ vars.ENABLE_STOCK_AI_DEBATE_VIEW || 'false' }}

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Mark start timestamp
        run: |
          echo "PIPELINE_START_TS=$(date +%s)" >> "$GITHUB_ENV"

      - name: Resolve Stock V2 runtime flags
        id: stock_v2_flags
        env:
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
        run: |
          llm_flag=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.enable_llm }}" != "true" ]; then
            llm_flag=""
          elif [ -n "$DASHSCOPE_API_KEY" ] || [ -n "$ALIBABA_API_KEY" ]; then
            llm_flag="--enable-llm --llm-event-cap 80 --llm-workers 10"
          fi
          printf "llm_flag=%s\n" "$llm_flag" >> "$GITHUB_OUTPUT"

      - name: Run Stock X supplement ingest (optional)
        if: ${{ env.ENABLE_STOCK_X_SOURCE == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GROK_API_BASE_URL: ${{ secrets.GROK_API_BASE_URL }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          GROK_MODEL: ${{ secrets.GROK_MODEL }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          cat > grok_apikey.txt <<EOF
          模型名字: ${GROK_MODEL}
          api地址: ${GROK_API_BASE_URL}
          apikey: ${GROK_API_KEY}
          EOF

          python -u scripts/stock_x_source_ingest.py \
            --mode ingest \
            --accounts-file config/us_stock_x_accounts.tsv \
            --topn 30 \
            --post-limit 20 \
            --workers 6 \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-x-supp"

      - name: Run Stock X quality governor (optional)
        if: ${{ env.ENABLE_STOCK_X_SOURCE == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_x_quality_governor.py \
            --lookback-days 7 \
            --topn 30 \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-x-quality"

      - name: Run Stock V2 incremental pipeline
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_pipeline_v2.py \
            --mode incremental \
            --hours 72 \
            --article-limit 2000 \
            --lookback-hours 240 \
            ${{ steps.stock_v2_flags.outputs.llm_flag }}

      - name: Backfill Chinese evidence texts (Stock V2)
        if: ${{ steps.stock_v2_flags.outputs.llm_flag != '' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_translate_backfill_v2.py \
            --active-only \
            --limit 250 \
            --scan-limit 8000 \
            --batch-size 250 \
            --workers 8

      - name: Refresh market digest prices
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/refresh_market_digest.py \
            --hours 168 \
            --limit 1200

      - name: Run Stock V3 eval (optional)
        if: ${{ env.ENABLE_STOCK_V3_EVAL == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_eval_v3.py \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-eval" \
            --window-hours 24 \
            --max-age-days 14 \
            --limit 2500

      - name: Run Stock V3 paper trading (optional)
        if: ${{ env.ENABLE_STOCK_V3_PAPER == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_paper_trading_v3.py \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-paper" \
            --topn 12 \
            --apply-constraints

      - name: Run Stock V3 portfolio constraints snapshot (optional)
        if: ${{ env.ENABLE_STOCK_V3_CONSTRAINTS == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_portfolio_constraints_v3.py \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-constraint" \
            --limit 220 \
            --max-positions 12 \
            --max-new-positions 12 \
            --max-single-ticker 1 \
            --max-gross-exposure 12 \
            --max-long-ratio 0.75 \
            --max-short-ratio 0.75 \
            --min-opportunity-score 70 \
            --min-confidence 0.55

      - name: Run Stock V3 champion/challenger (optional)
        if: ${{ env.ENABLE_STOCK_V3_CHALLENGER == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_champion_challenger_v3.py \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-cc" \
            --lookback-hours 168 \
            --limit 1500 \
            --promote-margin 0.03

      - name: Run Stock V3 drift monitor (optional)
        if: ${{ env.ENABLE_STOCK_V3_DRIFT == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_drift_monitor_v3.py \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-drift" \
            --window-hours 24 \
            --baseline-days 7 \
            --limit 4500

      - name: Build Stock V3 lifecycle report (optional)
        if: ${{ env.ENABLE_STOCK_V3_LIFECYCLE == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_lifecycle_report_v3.py \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-lifecycle" \
            --window-hours 24 \
            --limit 8000

      - name: Collect source health snapshot (V3 optional)
        if: ${{ env.ENABLE_STOCK_V3_RUN_LOG == 'true' || env.ENABLE_STOCK_V3_EVAL == 'true' || env.ENABLE_STOCK_V3_PAPER == 'true' || env.ENABLE_STOCK_V3_CHALLENGER == 'true' || env.ENABLE_STOCK_V3_DRIFT == 'true' || env.ENABLE_STOCK_V3_LIFECYCLE == 'true' || env.ENABLE_STOCK_V3_SUBSCRIPTION_ALERT == 'true' || env.ENABLE_STOCK_V3_CONSTRAINTS == 'true' || env.ENABLE_STOCK_V3_SCORECARD == 'true' || env.ENABLE_STOCK_V3_SHADOW_REPORT == 'true' || env.ENABLE_STOCK_V3_VALIDATION == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/source_health_collector_v3.py \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}" \
            --hours 24

      - name: Build Stock V3 daily scorecard (optional)
        if: ${{ env.ENABLE_STOCK_V3_SCORECARD == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_daily_scorecard_v3.py \
            --days 1 \
            --md-dir docs/reports \
            --csv-dir data/reports

      - name: Build Stock V3 shadow run report (optional)
        if: ${{ env.ENABLE_STOCK_V3_SHADOW_REPORT == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_shadow_run_report_v3.py \
            --days 7 \
            --output docs/reports/stock_v3_shadow_run_7d.md

      - name: Run Stock V3 validation suite (optional)
        if: ${{ env.ENABLE_STOCK_V3_VALIDATION == 'true' && github.event_name == 'workflow_dispatch' }}
        continue-on-error: true
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_v3_validation_suite.py \
            --output docs/reports/stock_v3_validation_report.md

      - name: Summarize Stock V2 metrics
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
        run: |
          duration=$(( $(date +%s) - ${PIPELINE_START_TS:-0} ))
          python -u scripts/stock_run_summary_v3.py \
            --duration-sec "$duration" \
            --health-date "$(date -u +%F)" \
            --health-run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

      - name: Upload Stock V3 reports artifact (optional)
        if: ${{ env.ENABLE_STOCK_V3_SCORECARD == 'true' || env.ENABLE_STOCK_V3_SHADOW_REPORT == 'true' || env.ENABLE_STOCK_V3_VALIDATION == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: stock-v3-reports-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            docs/reports/*.md
            data/reports/*.csv
          if-no-files-found: ignore

      - name: Dispatch Stock V3 subscription alerts (optional)
        if: ${{ env.ENABLE_STOCK_V3_SUBSCRIPTION_ALERT == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_subscription_alert_v3.py \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-subalert" \
            --sub-limit 60 \
            --opp-limit 200

      - name: Notify Feishu (Stock V3)
        if: ${{ always() }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_v3_notifier.py \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}" \
            --job-status "${{ job.status }}"

  legacy-fallback-analysis:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.legacy_fallback == true }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      LLM_VERBOSE_LOGS: ${{ vars.LLM_VERBOSE_LOGS || 'false' }}

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Validate LLM secrets
        env:
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
        run: |
          if [ -z "$DASHSCOPE_API_KEY" ] && [ -z "$ALIBABA_API_KEY" ]; then
            echo "::error::Missing DASHSCOPE_API_KEY / ALIBABA_API_KEY. Legacy analyzer cannot run."
            exit 1
          fi

      - name: Run legacy enhanced analyzer (manual fallback)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          WORKER_URL: ${{ secrets.WORKER_URL }}
          RAILWAY_URL: ${{ secrets.RAILWAY_URL }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/enhanced_analyzer.py \
            --enrich-signals-after-run \
            --enrich-hours 24 \
            --enrich-limit 30 \
            --enrich-workers 5

      - name: Refresh legacy market digest
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/refresh_market_digest.py \
            --hours 24 \
            --limit 500

      - name: Refresh legacy opportunity engine
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/refresh_opportunities.py \
            --hours 48 \
            --limit 800 \
            --topn 40
