name: Stock V2 Analysis After Crawl

on:
  workflow_run:
    workflows:
      - RSS Crawler
    types:
      - completed
  workflow_dispatch:
    inputs:
      legacy_fallback:
        description: "Run legacy enhanced analyzer pipeline"
        required: false
        default: false
        type: boolean
      enable_llm:
        description: "Enable LLM correction in Stock V2 pipeline"
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch || github.ref_name }}
  cancel-in-progress: false

jobs:
  stock-v2-analysis:
    if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || (github.event_name == 'workflow_dispatch' && inputs.legacy_fallback != true) }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      ENABLE_STOCK_V3_RUN_LOG: ${{ vars.ENABLE_STOCK_V3_RUN_LOG || 'false' }}
      ENABLE_STOCK_V3_EVAL: ${{ vars.ENABLE_STOCK_V3_EVAL || 'false' }}
      ENABLE_STOCK_V3_PAPER: ${{ vars.ENABLE_STOCK_V3_PAPER || 'false' }}

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Mark start timestamp
        run: |
          echo "PIPELINE_START_TS=$(date +%s)" >> "$GITHUB_ENV"

      - name: Resolve Stock V2 runtime flags
        id: stock_v2_flags
        env:
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
        run: |
          llm_flag=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.enable_llm }}" != "true" ]; then
            llm_flag=""
          elif [ -n "$DASHSCOPE_API_KEY" ] || [ -n "$ALIBABA_API_KEY" ]; then
            llm_flag="--enable-llm --llm-event-cap 80 --llm-workers 10"
          fi
          printf "llm_flag=%s\n" "$llm_flag" >> "$GITHUB_OUTPUT"

      - name: Run Stock V2 incremental pipeline
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/stock_pipeline_v2.py \
            --mode incremental \
            --hours 168 \
            --article-limit 3000 \
            --lookback-hours 336 \
            ${{ steps.stock_v2_flags.outputs.llm_flag }}

      - name: Refresh market digest prices
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/refresh_market_digest.py \
            --hours 168 \
            --limit 1200

      - name: Collect source health snapshot (V3 optional)
        if: ${{ env.ENABLE_STOCK_V3_RUN_LOG == 'true' || env.ENABLE_STOCK_V3_EVAL == 'true' || env.ENABLE_STOCK_V3_PAPER == 'true' }}
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/source_health_collector_v3.py \
            --run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}" \
            --hours 24

      - name: Summarize Stock V2 metrics
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
        run: |
          duration=$(( $(date +%s) - ${PIPELINE_START_TS:-0} ))
          python -u scripts/stock_run_summary_v3.py \
            --duration-sec "$duration" \
            --health-date "$(date -u +%F)" \
            --health-run-id "gha-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

  legacy-fallback-analysis:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.legacy_fallback == true }}
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Validate LLM secrets
        env:
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
        run: |
          if [ -z "$DASHSCOPE_API_KEY" ] && [ -z "$ALIBABA_API_KEY" ]; then
            echo "::error::Missing DASHSCOPE_API_KEY / ALIBABA_API_KEY. Legacy analyzer cannot run."
            exit 1
          fi

      - name: Run legacy enhanced analyzer (manual fallback)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          WORKER_URL: ${{ secrets.WORKER_URL }}
          RAILWAY_URL: ${{ secrets.RAILWAY_URL }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/enhanced_analyzer.py \
            --enrich-signals-after-run \
            --enrich-hours 24 \
            --enrich-limit 30 \
            --enrich-workers 5

      - name: Refresh legacy market digest
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/refresh_market_digest.py \
            --hours 24 \
            --limit 500

      - name: Refresh legacy opportunity engine
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python -u scripts/refresh_opportunities.py \
            --hours 48 \
            --limit 800 \
            --topn 40
