name: Hotspot Analysis

on:
  schedule:
    # åœ¨ç¾å›½ä¸œéƒ¨æ—¶é—´ä¸Šåˆ10ç‚¹å’Œæ™šä¸Š10ç‚¹è¿è¡Œ
    # ï¼ˆçˆ¬è™«åœ¨9ç‚¹/21ç‚¹è¿è¡Œï¼Œåˆ†æåœ¨1å°æ—¶åï¼‰
    - cron: '0 15 * * *'  # UTC 15:00 = ET 10:00 (å¤ä»¤æ—¶æœŸé—´)
    - cron: '0 3 * * *'   # UTC 03:00 = ET 22:00 (å¤ä»¤æ—¶æœŸé—´)
  workflow_dispatch:
    inputs:
      limit:
        description: 'æœ€å¤§å¤„ç†æ–‡ç« æ•° (é»˜è®¤: 500)'
        required: false
        default: '500'
      dry_run:
        description: 'è¯•è¿è¡Œæ¨¡å¼ (ä¸ä¿å­˜åˆ°æ•°æ®åº“)'
        required: false
        default: 'false'

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run Hotspot Analysis
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        ALIBABA_API_KEY: ${{ secrets.ALIBABA_API_KEY }}
      run: |
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "ğŸ” è¯•è¿è¡Œæ¨¡å¼"
          python scripts/analyzer.py --limit ${{ github.event.inputs.limit }} --dry-run
        else
          echo "ğŸš€ æ­£å¼è¿è¡Œ"
          python scripts/analyzer.py --limit ${{ github.event.inputs.limit }}
        fi
    
    - name: Generate Report
      if: always()
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        echo "ğŸ“Š ç”Ÿæˆåˆ†ææŠ¥å‘Š..."
        python -c "
        from supabase import create_client
        import os
        from datetime import datetime, timedelta
        
        supabase = create_client(
            os.getenv('SUPABASE_URL'),
            os.getenv('SUPABASE_KEY')
        )
        
        # è·å–ä»Šå¤©çš„ç»Ÿè®¡
        today = datetime.now().strftime('%Y-%m-%d')
        
        # èšç±»ç»Ÿè®¡
        clusters_result = supabase.table('analysis_clusters').select('*').gte('created_at', today).execute()
        clusters = clusters_result.data
        
        # ä¿¡å·ç»Ÿè®¡
        signals_result = supabase.table('analysis_signals').select('*').gte('created_at', today).execute()
        signals = signals_result.data
        
        print(f'ğŸ“ˆ ä»Šæ—¥çƒ­ç‚¹åˆ†æç»Ÿè®¡ ({today}):')
        print(f'  - æ–°å¢èšç±»: {len(clusters)}')
        print(f'  - æ£€æµ‹åˆ°ä¿¡å·: {len(signals)}')
        
        if signals:
            print('\\nğŸ”” ä¿¡å·è¯¦æƒ…:')
            for s in signals[:5]:
                icon = {'velocity_spike': 'ğŸ“ˆ', 'convergence': 'ğŸ¯', 'triangulation': 'ğŸ”º', 'hotspot_escalation': 'ğŸ”¥'}.get(s['signal_type'], 'âš¡')
                print(f\"  {icon} {s['name']}: {s['description'][:60]}... (ç½®ä¿¡åº¦: {s['confidence']:.2f})\")
        
        if clusters:
            print('\\nğŸ“° çƒ­ç‚¹èšç±»:')
            for c in sorted(clusters, key=lambda x: x.get('confidence', 0), reverse=True)[:3]:
                print(f\"  - {c['primary_title'][:50]}...\")
                print(f\"    æ‘˜è¦: {c['summary'][:80]}...\")
        "
    
    - name: Cleanup Old Data
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        echo "ğŸ§¹ æ¸…ç†è¿‡æœŸåˆ†ææ•°æ®..."
        python -c "
        from supabase import create_client
        import os
        from datetime import datetime, timedelta
        
        supabase = create_client(
            os.getenv('SUPABASE_URL'),
            os.getenv('SUPABASE_KEY')
        )
        
        # åˆ é™¤90å¤©å‰çš„æ•°æ®
        cutoff = (datetime.now() - timedelta(days=90)).isoformat()
        
        # åˆ é™¤æ—§ä¿¡å·
        result = supabase.table('analysis_signals').delete().lt('created_at', cutoff).execute()
        print(f'  åˆ é™¤è¿‡æœŸä¿¡å·: {len(result.data)} æ¡')
        
        # åˆ é™¤æ—§èšç±»ï¼ˆæ²¡æœ‰å…³è”æ–‡ç« çš„ï¼‰
        # æ³¨æ„ï¼šè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥å…ˆæ£€æŸ¥article_analysesè¡¨
        print('  æ•°æ®æ¸…ç†å®Œæˆ')
        "
    
    - name: Notify on Failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `âŒ çƒ­ç‚¹åˆ†æå¤±è´¥ - ${new Date().toISOString()}`,
            body: `å·¥ä½œæµè¿è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚\\n\\nè¿è¡Œé“¾æ¥: ${context.payload.repository.html_url}/actions/runs/${context.runId}`
          })
